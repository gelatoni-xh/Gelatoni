# 比赛数据参数校验服务设计文档

## 概述

本服务为2K篮球游戏数据录入提供全面的参数校验功能，确保数据的一致性和完整性，同时尊重用户的录入习惯。

## 设计原则

1. **服务于用户习惯**：不强制限制用户的操作模式，而是提供数据一致性校验
2. **灵活性优先**：支持机器人对局时不录入对方球员数据的场景
3. **全面覆盖**：提供多维度的数据校验能力
4. **友好提示**：提供清晰的错误信息帮助用户修正数据

## 核心功能

### 1. 基础数据校验
- 比赛基础信息完整性校验
- 必填字段非空校验（已在Request层通过注解实现）

### 2. 队伍统计数据校验
- **队伍数量校验**：必须且只能有一条我方队伍数据和一条对方队伍数据
- **数据合理性校验**：
  - 投篮命中数 ≤ 投篮尝试数
  - 三分命中数 ≤ 三分尝试数  
  - 总篮板数 = 进攻篮板 + 防守篮板
  - 所有统计数据 ≥ 0

### 3. 球员统计数据校验
- **我方球员校验**：必须且只能有3人
- **对方球员校验**：
  - 机器人对局：可以为0人或3人
  - 非机器人对局：必须有3人
- **数据合理性校验**：
  - MVP和SVP不能同时为true
  - 投篮命中数 ≤ 投篮尝试数
  - 三分命中数 ≤ 三分尝试数
  - 所有统计数据 ≥ 0

### 4. 跨数据一致性校验
- **得分一致性**：
  - 比赛信息得分 = 队伍统计得分
  - 队伍统计得分 = 对应球员得分总和
- **统计数据一致性**：
  - 队伍各项统计数据 = 对应球员统计数据总和
  - 包括：投篮、三分、助攻、篮板、抢断、盖帽、灌篮等

## 使用场景示例

### 正常对局录入
```
我方球员：3人（必须）
对方球员：3人（必须）
校验点：
- 我方队伍统计数据 = 3名我方球员数据总和
- 对方队伍统计数据 = 3名对方球员数据总和
- 比赛得分 = 队伍得分
```

### 机器人对局录入
```
我方球员：3人（必须）
对方球员：0人或3人（可选）
校验点：
- 我方队伍统计数据 = 3名我方球员数据总和
- 比赛得分 = 队伍得分
- （如果录入对方数据）对方队伍统计数据 = 对方球员数据总和
```

## 异常处理

### 业务异常类型
使用`BizException`配合`BizErrorCode.INVALID_PARAM`抛出校验失败信息

### 主要校验错误
1. 队伍数量不符
2. 球员数量不符
3. 数据逻辑关系错误
4. 统计数据不一致
5. 数值超出合理范围

## 集成方式

### Service层集成
在`MatchGameAppService`中自动调用校验服务：

```java
@Override
public Long createMatchGame(MatchGameCreateQuery query) {
    // 数据校验
    dataValidator.validateCreateData(query);
    
    return matchGameDomainService.createMatchGame(query);
}
```

### Controller层集成
在Controller中提供DTO级别的前置校验：

```java
@PostMapping("/create")
public BaseResponse<Long> create(@RequestBody MatchGameCreateRequest request) {
    // 先进行DTO级别数据校验
    matchGameAppService.validateCreateRequest(request);
    
    MatchGameCreateQuery query = assembler.toDomainQuery(request);
    Long matchId = matchGameAppService.createMatchGame(query);
    return BaseResponse.success(matchId);
}
```

## 测试覆盖

提供完整的单元测试覆盖以下场景：
- 正常对局数据校验
- 机器人对局数据校验
- 各种异常情况校验
- 边界条件测试

## 扩展性考虑

1. **配置化校验规则**：未来可通过配置文件调整校验规则
2. **插件化架构**：支持添加自定义校验规则
3. **国际化支持**：错误信息支持多语言
4. **性能优化**：针对大数据量场景的校验优化

## 注意事项

1. 校验服务不影响核心业务流程，仅提供数据质量保障
2. 机器人对局场景下不对对方球员数据做强制要求
3. 所有校验都是为了数据一致性，不改变用户的录入习惯
4. 错误信息设计注重用户体验，提供明确的修正指导